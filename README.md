# Задание 1. Анализ и планирование

![](/diagrams/context/Умный%20дом_AsIs.svg)
[Ссылка на исходник](/diagrams/context/Умный%20дом_AsIs.puml)

**Управление отоплением:**

* Пользователи могут удалённо включать/выключать отопление в своих домах.
* Пользователи могут устанавливать желаемую температуру.
* Система автоматически поддерживает заданную температуру, регулируя подачу тепла.

**Мониторинг температуры:**

* Система получает данные о температуре с датчиков, установленных в домах.
* Пользователи могут просматривать текущую температуру в своих домах через веб-интерфейс.

**1.1 Анализ архитектуры монолитного приложения**

**Язык программирования**: Java. Популярный язык общего назначения. Много готовых решений, фреймворков. Можно создавать как небольшие приложения, так и большие системы.  

**База данных**: PostgreSQL. Реляционная БД. Соблюдает принципы ACID. Выдерживает большие нагрузки как OLAP, так и OLTP. Можно использовать плагины для тонкой настройки и расширения функционала.  

**Архитектура**: Монолитная, все компоненты системы (обработка запросов, бизнес-логика, работа с данными) находятся в рамках одного приложения.  
Минусы: 
- высокий риск ошибок (изменения в одной части приложения могут непредсказуемо влиять на другие части); 
- длительные циклы разработки и развёртывания (при каждом изменении приходится тестировать всё приложение целиком); 
- трудно масштабировать отдельные компоненты системы; 
- трудно управлять командой.  

**Взаимодействие**: Синхронное, запросы обрабатываются последовательно.  
Плюсы: 
- простота, предсказуемость, лёгкость отладки и мониторинга.  

Минусы: 
- возможны высокие задержки, увеличение зависимости между сервисами, ограниченная масштабируемость из-за блокирующих вызовов.  

**Развертывание**: Требует остановки всего приложения. Пользователи могут сталкиваться с недоступностью на время развертывания.

**1.2 Домены и границы контекстов**

**Домен: управление устройствами**

Поддомен: управление отоплением  
- Контекст: включение\выключение устройства
- Контекст: установка необходимой температуры

Поддомен: автоматическое поддержание температуры
- Контекст: регулировка подачи тепла

**Домен: мониторинг температуры**

- Контекст: получение данных с датчиков о температуре
- Контекст: отображение текущей температуры в доме пользователя

# Задание 2. Проектирование микросервисной архитектуры

![C4 — Уровень контейнеров (Containers)](/diagrams/containers/Умный%20дом_containers.png)
[Ссылка на исходник](/diagrams/containers/Умный%20дом_containers.puml)

**Декомпозиция на микросервисы**

1. **Телеметрия.API** - сервис, который принимает телеметрию от датчиков и команды на управление датчиками от внутренних сервисов. Доступ к БД на чтение. Доступ к брокеру сообщений для записи телеметрии.
1. **Телеметрия.Service** - сервис для отправки команд на датчики внешней системы. Так же сервис получает значения телеметрии с брокера сообщений и записывает их в базу данных.
3. **Управление устройствами** - микросервис, занимается ведением перечня датчиков и отвечает за выполнение команд пользователя.

**Взаимодействие**

1. Все запросы пользователя поступают в API Gateway.
2. API Gateway маршрутизирует запросы согласно роутингу микросервисам.
3. Команды на управления дитчиками поступают в API сервиса телеметрии и складыватся в брокер сообщений. Далее команды отправляются фоновым сервисом во внешнюю систему для равномерного распределения нагрузки
4. Значения телеметрии с датчиков поступают в API сервиса телеметрии и складыватся в брокер сообщений. Далее фоновый сервис сохраняет значения телеметрии в базе данных пачкой (bulk insert) для большей производительности БД на запись.
5. Запросы получения данных телеметрии обрабатывает API сервиса телеметрии и получает данные из базы данных.

**C4 — Уровень компонентов (Components)**  

![](diagrams/components/Умный%20дом_components.png)

[Исходник](diagrams/components/Умный%20дом_components.puml)

**C4 — Уровень кода (Code)**  

![](diagrams/code/TelemetryApi.png)

[Исходник](diagrams/code/TelemetryApi.puml)

# Задание 3. Разработка ER-диаграммы

![ER-диаграмма](diagrams/er/ER%20Умный%20дом.png)

[Исходник](diagrams/er/er-diagram.puml)

**Описание связей**

* **Пользователь — Дом:** один-ко-многим, один пользователь может иметь доступ к нескольким домам, но каждый дом связан только с одним пользователем.
* **Устройство — Модуль:** один-ко-многим, к одному модулю могут быть подключены несколько устройств, но каждое устройство связано только с одним модулем.
* **Телеметрия — Устройство:** один-ко-многим, одно устройство генерирует несколько единиц данных телеметрии, но одна единица данных может быть создана только одним устройством.
* **Устройство — Тип устройства:** один-ко-многим, один тип устройства может быть у нескольких устройств.

# Задание 4. Создание и документирование API

![](api/openapi.png)

[Исходник](api/openapi3_0.yaml)